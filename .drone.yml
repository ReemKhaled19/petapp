kind: pipeline
type: docker
name: build-and-push-from-ci

# Ø§Ø³ØªØ®Ø¯Ø§Ù… Docker Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù€ host Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† DinD
steps:
  - name: check-docker
    image: docker:27-cli
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - |
        echo "ğŸ” Checking Docker connection..."
        docker version
        echo ""
        echo "âœ… Docker is ready!"
        echo ""
        docker info | grep -E "Server Version|Storage Driver|Operating System" || true

  - name: build_and_push_to_dockerhub
    image: docker:27-cli
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    environment:
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ Starting Docker Build Process"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        echo "ğŸ” Logging into Docker Hub..."
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        echo "âœ… Login successful!"
        echo ""
        
        echo "ğŸ—ï¸  Building Docker image..."
        echo "   Repository: mohamedelgarhy/spring-petclinic"
        echo "   Commit: ${DRONE_COMMIT_SHA:0:8}"
        echo "   Build: ${DRONE_BUILD_NUMBER}"
        echo ""
        docker build -t mohamedelgarhy/spring-petclinic:latest .
        echo "âœ… Build completed!"
        echo ""
        
        echo "ğŸ·ï¸  Tagging images..."
        docker tag mohamedelgarhy/spring-petclinic:latest mohamedelgarhy/spring-petclinic:${DRONE_COMMIT_SHA:0:8}
        docker tag mohamedelgarhy/spring-petclinic:latest mohamedelgarhy/spring-petclinic:${DRONE_BUILD_NUMBER}
        echo "âœ… Tagged: latest, ${DRONE_COMMIT_SHA:0:8}, ${DRONE_BUILD_NUMBER}"
        echo ""
        
        echo "ğŸ“¤ Pushing images to Docker Hub..."
        docker push mohamedelgarhy/spring-petclinic:latest
        echo "   âœ“ Pushed: latest"
        docker push mohamedelgarhy/spring-petclinic:${DRONE_COMMIT_SHA:0:8}
        echo "   âœ“ Pushed: ${DRONE_COMMIT_SHA:0:8}"
        docker push mohamedelgarhy/spring-petclinic:${DRONE_BUILD_NUMBER}
        echo "   âœ“ Pushed: ${DRONE_BUILD_NUMBER}"
        echo ""
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ SUCCESS! All images pushed to Docker Hub"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Available images:"
        echo "   â€¢ mohamedelgarhy/spring-petclinic:latest"
        echo "   â€¢ mohamedelgarhy/spring-petclinic:${DRONE_COMMIT_SHA:0:8}"
        echo "   â€¢ mohamedelgarhy/spring-petclinic:${DRONE_BUILD_NUMBER}"
        echo ""
        echo "ğŸ”— View on Docker Hub:"
        echo "   https://hub.docker.com/r/mohamedelgarhy/spring-petclinic/tags"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Mount host's Docker socket
volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock

# ğŸ”’ Only run when triggered by Semaphore API
trigger:
  event:
    exclude:
      - push
      - pull_request
      - tag
      - promote
      - rollback
      - cron
